<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Offers - Freezy Bite Dashboard</title>
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Offers Page Specific Styles */
        .offers-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .offer-stat-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .offer-stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .offer-stat-card .icon.total {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }

        .offer-stat-card .icon.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .offer-stat-card .icon.savings {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .offer-stat-card .icon.expired {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .offer-stat-card .info h4 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .offer-stat-card .info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Offers Grid */
        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .offer-card {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .offer-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .offer-card.inactive {
            opacity: 0.6;
        }

        .offer-card-image {
            height: 200px;
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            position: relative;
            overflow: hidden;
        }

        .offer-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .offer-card-image .no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .offer-card-image .no-image i {
            font-size: 4rem;
            opacity: 0.3;
        }

        .discount-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(135deg, #a31545, #880e4f);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(163, 21, 69, 0.4);
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }

        .status-badge.inactive {
            background: rgba(107, 114, 128, 0.9);
            color: white;
        }

        .status-badge.scheduled {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        .offer-card-body {
            padding: 1.25rem;
        }

        .offer-card-body h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .price-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .sale-price {
            color: #a31545;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .offer-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .offer-meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
        }

        .offer-card-footer {
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-color);
        }

        .offer-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-muted);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        /* Preview Banner */
        .preview-banner {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .preview-banner h2 {
            color: #a31545;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .preview-banner p {
            color: #6b7280;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.2;
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .offers-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .offers-grid {
                grid-template-columns: 1fr;
            }

            .offer-stat-card {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .offers-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-logo">
                <div class="logo-icon">
                    <i class="fas fa-snowflake"></i>
                </div>
                <span>Freezy Bite</span>
            </a>
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li>
                    <a href="index.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">Overview</span>
                    </a>
                </li>
                <li>
                    <a href="content.html" class="nav-item">
                        <i class="fas fa-palette"></i>
                        <span class="nav-text">Website Content</span>
                    </a>
                </li>
                <li>
                    <a href="offers.html" class="nav-item active">
                        <i class="fas fa-tags"></i>
                        <span class="nav-text">Special Offers</span>
                    </a>
                </li>
                <li>
                    <a href="products.html" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span class="nav-text">Products</span>
                    </a>
                </li>
                <li>
                    <a href="orders.html" class="nav-item">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="nav-text">Orders</span>
                    </a>
                </li>
                <li>
                    <a href="customers.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Customers</span>
                    </a>
                </li>
                <li>
                    <a href="messages.html" class="nav-item">
                        <i class="fas fa-envelope"></i>
                        <span class="nav-text">Messages</span>
                    </a>
                </li>
                <li>
                    <a href="analytics.html" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-text">Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="inventory.html" class="nav-item">
                        <i class="fas fa-warehouse"></i>
                        <span class="nav-text">Inventory</span>
                    </a>
                </li>
                <li>
                    <a href="employees.html" class="nav-item">
                        <i class="fas fa-id-badge"></i>
                        <span class="nav-text">Employees</span>
                    </a>
                </li>
                <li>
                    <a href="users.html" class="nav-item">
                        <i class="fas fa-user-shield"></i>
                        <span class="nav-text">Users</span>
                    </a>
                </li>
                <li>
                    <a href="trash.html" class="nav-item">
                        <i class="fas fa-trash-alt"></i>
                        <span class="nav-text">Trash</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span class="nav-text">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <img src="/assets/icons/profile.svg" alt="Admin"
                    class="user-avatar">
                <div class="user-info">
                    <h4>Admin User</h4>
                    <p>admin@freezybite.com</p>
                </div>
            </div>
            <button class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search offers..." id="offerSearchInput"
                        oninput="searchOffers(this.value)">
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="badge" style="display: none;"></span>
                </button>
                <button class="header-btn" onclick="showMessages()">
                    <i class="fas fa-envelope"></i>
                    <span class="badge" style="display: none;"></span>
                </button>
                <button class="header-btn" onclick="showTrashModal()" title="Trash">
                    <i class="fas fa-trash-alt"></i>
                    <span class="badge" id="headerTrashBadge" style="display: none;"></span>
                </button>
                <img src="/assets/icons/profile.svg" alt="Admin"
                    class="header-avatar">
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Section Header -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title"><i class="fas fa-tags"
                                style="color: #a31545; margin-right: 0.5rem;"></i>Special Offers</h1>
                        <p class="section-subtitle">Manage discount deals displayed on your website's offers page.</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="previewOffersPage()">
                            <i class="fas fa-external-link-alt"></i>
                            Preview Page
                        </button>
                        <button class="btn btn-primary" onclick="openAddOfferModal()">
                            <i class="fas fa-plus"></i>
                            Add Offer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Banner -->
            <div class="preview-banner">
                <h2>Special Offers</h2>
                <p id="offerSubtitle">Crunchy deals that won't last long — grab your favorites now.</p>
                <button class="btn btn-sm" style="background: #a31545; color: white; margin-top: 0.5rem;"
                    onclick="editOfferPageSettings()">
                    <i class="fas fa-edit"></i> Edit Page Title & Subtitle
                </button>
            </div>

            <!-- Stats -->
            <div class="offers-stats">
                <div class="offer-stat-card">
                    <div class="icon total">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="info">
                        <h4 id="totalOffersCount">--</h4>
                        <p>Total Offers</p>
                    </div>
                </div>
                <div class="offer-stat-card">
                    <div class="icon active">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="info">
                        <h4 id="activeOffersCount">--</h4>
                        <p>Active Offers</p>
                    </div>
                </div>
                <div class="offer-stat-card">
                    <div class="icon savings">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="info">
                        <h4 id="avgDiscountCount">--</h4>
                        <p>Average Discount</p>
                    </div>
                </div>
                <div class="offer-stat-card">
                    <div class="icon expired">
                        <i class="fas fa-eye-slash"></i>
                    </div>
                    <div class="info">
                        <h4 id="inactiveOffersCount">--</h4>
                        <p>Inactive</p>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="data-card" style="margin-bottom: 1.5rem; padding: 1rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="filterOffers('all')" id="filterAll">All
                            Offers</button>
                        <button class="btn btn-sm btn-secondary" onclick="filterOffers('active')" id="filterActive">
                            <i class="fas fa-check"></i> Active
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="filterOffers('inactive')" id="filterInactive">
                            <i class="fas fa-eye-slash"></i> Inactive
                        </button>
                    </div>
                    <div>
                        <select class="form-select" id="sortOffers" onchange="sortOffers(this.value)"
                            style="min-width: 150px;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="discount-high">Highest Discount</option>
                            <option value="discount-low">Lowest Discount</option>
                            <option value="price-high">Highest Price</option>
                            <option value="price-low">Lowest Price</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Offers Grid -->
            <div class="offers-grid" id="offersGrid">
                <!-- Offers will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Add Offer Modal -->
    <div class="modal-overlay" id="addOfferModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-plus-circle"
                        style="color: #a31545; margin-right: 0.5rem;"></i>Add New Offer</h2>
                <button class="modal-close" onclick="closeModal('addOfferModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addOfferForm" onsubmit="addOffer(event)">
                <div class="modal-body">
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="width: 150px; height: 150px; margin: 0 auto; border-radius: var(--border-radius-lg); overflow: hidden; background: linear-gradient(135deg, #fce4ec, #f8bbd9); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed #a31545;"
                            onclick="document.getElementById('addOfferImage').click()">
                            <img id="addOfferImagePreview" src="" alt="Preview"
                                style="display: none; width: 100%; height: 100%; object-fit: cover;">
                            <div id="addOfferImagePlaceholder">
                                <i class="fas fa-camera" style="font-size: 2rem; color: #a31545; opacity: 0.5;"></i>
                                <p style="color: #a31545; font-size: 0.8rem; margin-top: 0.5rem;">Click to upload</p>
                            </div>
                        </div>
                        <input type="file" id="addOfferImage" accept="image/*" style="display: none;"
                            onchange="previewAddOfferImage(event)">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Product Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="addOfferName" placeholder="e.g., Snickers Pack"
                            required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Original Price (EGP) <span class="required">*</span></label>
                            <input type="number" class="form-input" id="addOfferOriginalPrice" placeholder="175"
                                required oninput="calculateDiscount('add')">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sale Price (EGP) <span class="required">*</span></label>
                            <input type="number" class="form-input" id="addOfferSalePrice" placeholder="140" required
                                oninput="calculateDiscount('add')">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Discount</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="background: linear-gradient(135deg, #a31545, #880e4f); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700;"
                                id="addDiscountPreview">-0%</div>
                            <span style="color: var(--text-muted); font-size: 0.85rem;">Auto-calculated from
                                prices</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Product Link (optional)</label>
                        <input type="text" class="form-input" id="addOfferLink" placeholder="/products/snickers-pack">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="addOfferStatus">
                            <option value="active">Active - Show on website</option>
                            <option value="inactive">Inactive - Hidden from website</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addOfferModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #a31545;">
                        <i class="fas fa-plus"></i> Add Offer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Offer Modal -->
    <div class="modal-overlay" id="editOfferModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-edit" style="color: #a31545; margin-right: 0.5rem;"></i>Edit
                    Offer</h2>
                <button class="modal-close" onclick="closeModal('editOfferModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editOfferForm" onsubmit="updateOffer(event)">
                <input type="hidden" id="editOfferId">
                <div class="modal-body">
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="width: 150px; height: 150px; margin: 0 auto; border-radius: var(--border-radius-lg); overflow: hidden; background: linear-gradient(135deg, #fce4ec, #f8bbd9); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed #a31545;"
                            onclick="document.getElementById('editOfferImage').click()">
                            <img id="editOfferImagePreview" src="" alt="Preview"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <input type="file" id="editOfferImage" accept="image/*" style="display: none;"
                            onchange="previewEditOfferImage(event)">
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Click image to
                            change</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Product Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="editOfferName" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Original Price (EGP) <span class="required">*</span></label>
                            <input type="number" class="form-input" id="editOfferOriginalPrice" required
                                oninput="calculateDiscount('edit')">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sale Price (EGP) <span class="required">*</span></label>
                            <input type="number" class="form-input" id="editOfferSalePrice" required
                                oninput="calculateDiscount('edit')">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Discount</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="background: linear-gradient(135deg, #a31545, #880e4f); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700;"
                                id="editDiscountPreview">-0%</div>
                            <span style="color: var(--text-muted); font-size: 0.85rem;">Auto-calculated from
                                prices</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Product Link (optional)</label>
                        <input type="text" class="form-input" id="editOfferLink">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editOfferStatus">
                            <option value="active">Active - Show on website</option>
                            <option value="inactive">Inactive - Hidden from website</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editOfferModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #a31545;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Page Settings Modal -->
    <div class="modal-overlay" id="pageSettingsModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-cog" style="color: #a31545; margin-right: 0.5rem;"></i>Offers
                    Page Settings</h2>
                <button class="modal-close" onclick="closeModal('pageSettingsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="pageSettingsForm" onsubmit="savePageSettings(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Page Title</label>
                        <input type="text" class="form-input" id="pageTitle" value="Special Offers">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" id="pageSubtitle"
                            value="Crunchy deals that won't last long — grab your favorites now.">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('pageSettingsModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #a31545;">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exclamation-triangle"
                        style="color: var(--danger); margin-right: 0.5rem;"></i>Delete Offer</h2>
                <button class="modal-close" onclick="closeModal('confirmDeleteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 1rem;">Are you sure you want to delete this offer?</p>
                <p style="font-weight: 600; color: var(--text-primary);" id="deleteOfferName"></p>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 1rem;">This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeModal('confirmDeleteModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteOffer()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/dashboard.js"></script>
    <script>
        // Offers Data - now loaded from API
        let specialOffers = [];

        let pageSettings = {
            title: 'Special Offers',
            subtitle: "Crunchy deals that won't last long — grab your favorites now."
        };

        let currentFilter = 'all';
        let currentSort = 'newest';
        let deleteOfferId = null;
        let addOfferImageData = null;
        let editOfferImageData = null;

        // API helpers
        function getToken() {
            return localStorage.getItem('freezyBiteAdminToken');
        }

        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api/admin${endpoint}`, { ...options, headers });
            if (!response.ok) throw new Error('API error');
            return response.json();
        }

        // Initialize - load from API
        document.addEventListener('DOMContentLoaded', async function () {
            await loadOffersFromAPI();
            document.getElementById('offerSubtitle').textContent = pageSettings.subtitle;
        });

        // Load offers from API
        async function loadOffersFromAPI() {
            try {
                const data = await apiCall('/offers?all=true');
                specialOffers = data.map(o => ({
                    id: o.id,
                    name: o.name,
                    originalPrice: parseFloat(o.originalPrice),
                    salePrice: parseFloat(o.salePrice),
                    image: o.image || '',
                    link: `/products/${o.productSku}`,
                    productSku: o.productSku,
                    status: o.isActive ? 'active' : 'inactive',
                    createdAt: o.createdAt ? new Date(o.createdAt).toISOString().split('T')[0] : ''
                }));
                renderOffers();
                updateStats();
            } catch (err) {
                console.error('Failed to load offers:', err);
                showAlert('error', 'Failed to load offers from server');
            }
        }

        // Update stats
        function updateStats() {
            const total = specialOffers.length;
            const active = specialOffers.filter(o => o.status === 'active').length;
            const inactive = specialOffers.filter(o => o.status === 'inactive').length;

            let totalDiscount = 0;
            specialOffers.forEach(o => {
                totalDiscount += Math.round((1 - o.salePrice / o.originalPrice) * 100);
            });
            const avgDiscount = total > 0 ? Math.round(totalDiscount / total) : 0;

            document.getElementById('totalOffersCount').textContent = total;
            document.getElementById('activeOffersCount').textContent = active;
            document.getElementById('inactiveOffersCount').textContent = inactive;
            document.getElementById('avgDiscountCount').textContent = avgDiscount + '%';
        }

        // Render offers
        function renderOffers() {
            const container = document.getElementById('offersGrid');

            let filteredOffers = [...specialOffers];

            // Filter
            if (currentFilter === 'active') {
                filteredOffers = filteredOffers.filter(o => o.status === 'active');
            } else if (currentFilter === 'inactive') {
                filteredOffers = filteredOffers.filter(o => o.status === 'inactive');
            }

            // Sort
            switch (currentSort) {
                case 'newest':
                    filteredOffers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredOffers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'discount-high':
                    filteredOffers.sort((a, b) => {
                        const discA = (1 - a.salePrice / a.originalPrice);
                        const discB = (1 - b.salePrice / b.originalPrice);
                        return discB - discA;
                    });
                    break;
                case 'discount-low':
                    filteredOffers.sort((a, b) => {
                        const discA = (1 - a.salePrice / a.originalPrice);
                        const discB = (1 - b.salePrice / b.originalPrice);
                        return discA - discB;
                    });
                    break;
                case 'price-high':
                    filteredOffers.sort((a, b) => b.salePrice - a.salePrice);
                    break;
                case 'price-low':
                    filteredOffers.sort((a, b) => a.salePrice - b.salePrice);
                    break;
            }

            if (filteredOffers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tags"></i>
                        <h3>No offers found</h3>
                        <p>Create your first special offer to attract customers!</p>
                        <button class="btn btn-primary" style="background: #a31545;" onclick="openAddOfferModal()">
                            <i class="fas fa-plus"></i> Add Offer
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredOffers.map(offer => {
                const discount = Math.round((1 - offer.salePrice / offer.originalPrice) * 100);

                return `
                    <div class="offer-card ${offer.status === 'inactive' ? 'inactive' : ''}">
                        <div class="offer-card-image">
                            ${offer.image ?
                        `<img src="${offer.image}" alt="${offer.name}">` :
                        `<div class="no-image"><i class="fas fa-image"></i></div>`
                    }
                            <span class="discount-badge">-${discount}%</span>
                            <span class="status-badge ${offer.status}">${offer.status}</span>
                        </div>
                        <div class="offer-card-body">
                            <h3>${offer.name}</h3>
                            <div class="price-row">
                                <span class="original-price">${offer.originalPrice} EGP</span>
                                <span class="sale-price">${offer.salePrice} EGP</span>
                            </div>
                            <div class="offer-meta">
                                <span class="offer-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    ${offer.createdAt}
                                </span>
                                <span class="offer-meta-item">
                                    <i class="fas fa-coins"></i>
                                    Save ${offer.originalPrice - offer.salePrice} EGP
                                </span>
                            </div>
                        </div>
                        <div class="offer-card-footer">
                            <label class="toggle-switch" title="Toggle visibility">
                                <input type="checkbox" ${offer.status === 'active' ? 'checked' : ''} onchange="toggleOfferStatus(${offer.id})">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="offer-actions">
                                <button class="action-btn edit" onclick="editOffer(${offer.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteOffer(${offer.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter offers
        function filterOffers(filter) {
            currentFilter = filter;

            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });

            const activeBtn = document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1));
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }

            renderOffers();
        }

        // Sort offers
        function sortOffers(sort) {
            currentSort = sort;
            renderOffers();
        }

        // Search offers
        function searchOffers(term) {
            const cards = document.querySelectorAll('.offer-card');
            const searchTerm = term.toLowerCase();

            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Toggle offer status - NOW SAVES TO API
        async function toggleOfferStatus(id) {
            const offer = specialOffers.find(o => o.id === id);
            if (!offer) return;

            const newStatus = offer.status === 'active' ? false : true;

            try {
                await apiCall(`/offers/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ isActive: newStatus })
                });

                offer.status = newStatus ? 'active' : 'inactive';
                renderOffers();
                updateStats();
                showAlert('success', `Offer "${offer.name}" is now ${offer.status}`);
            } catch (err) {
                console.error('Failed to toggle offer:', err);
                showAlert('error', 'Failed to update offer');
                renderOffers(); // Re-render to reset checkbox
            }
        }

        // Calculate discount preview
        function calculateDiscount(mode) {
            const prefix = mode === 'add' ? 'add' : 'edit';
            const originalPrice = parseFloat(document.getElementById(prefix + 'OfferOriginalPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById(prefix + 'OfferSalePrice').value) || 0;

            let discount = 0;
            if (originalPrice > 0 && salePrice > 0 && salePrice < originalPrice) {
                discount = Math.round((1 - salePrice / originalPrice) * 100);
            }

            document.getElementById(prefix + 'DiscountPreview').textContent = `-${discount}%`;
        }

        // Preview image handlers
        function previewAddOfferImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    addOfferImageData = e.target.result;
                    document.getElementById('addOfferImagePreview').src = e.target.result;
                    document.getElementById('addOfferImagePreview').style.display = 'block';
                    document.getElementById('addOfferImagePlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function previewEditOfferImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    editOfferImageData = e.target.result;
                    document.getElementById('editOfferImagePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Open add offer modal
        function openAddOfferModal() {
            document.getElementById('addOfferForm').reset();
            document.getElementById('addOfferImagePreview').style.display = 'none';
            document.getElementById('addOfferImagePlaceholder').style.display = 'block';
            document.getElementById('addDiscountPreview').textContent = '-0%';
            addOfferImageData = null;
            openModal('addOfferModal');
        }

        // Add offer - NOW SAVES TO API
        async function addOffer(event) {
            event.preventDefault();

            const name = document.getElementById('addOfferName').value;
            const originalPrice = parseInt(document.getElementById('addOfferOriginalPrice').value);
            const salePrice = parseInt(document.getElementById('addOfferSalePrice').value);
            const status = document.getElementById('addOfferStatus').value;
            const discount = Math.round((1 - salePrice / originalPrice) * 100);

            // Generate SKU from name
            const productSku = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

            try {
                const newOffer = await apiCall('/offers', {
                    method: 'POST',
                    body: JSON.stringify({
                        productSku,
                        name,
                        originalPrice,
                        salePrice,
                        discount,
                        image: addOfferImageData || '',
                        isActive: status === 'active'
                    })
                });

                closeModal('addOfferModal');
                await loadOffersFromAPI();
                showAlert('success', `Offer "${name}" added successfully!`);
            } catch (err) {
                console.error('Failed to add offer:', err);
                showAlert('error', 'Failed to add offer');
            }
        }

        // Edit offer
        function editOffer(id) {
            const offer = specialOffers.find(o => o.id === id);
            if (!offer) return;

            document.getElementById('editOfferId').value = offer.id;
            document.getElementById('editOfferName').value = offer.name;
            document.getElementById('editOfferOriginalPrice').value = offer.originalPrice;
            document.getElementById('editOfferSalePrice').value = offer.salePrice;
            document.getElementById('editOfferLink').value = offer.link || '';
            document.getElementById('editOfferStatus').value = offer.status;

            const discount = Math.round((1 - offer.salePrice / offer.originalPrice) * 100);
            document.getElementById('editDiscountPreview').textContent = `-${discount}%`;

            if (offer.image) {
                document.getElementById('editOfferImagePreview').src = offer.image;
            } else {
                document.getElementById('editOfferImagePreview').src = '/assets/icons/profile.svg';
            }

            editOfferImageData = offer.image;

            openModal('editOfferModal');
        }

        // Update offer - NOW SAVES TO API
        async function updateOffer(event) {
            event.preventDefault();

            const id = parseInt(document.getElementById('editOfferId').value);
            const offer = specialOffers.find(o => o.id === id);
            if (!offer) return;

            const name = document.getElementById('editOfferName').value;
            const originalPrice = parseInt(document.getElementById('editOfferOriginalPrice').value);
            const salePrice = parseInt(document.getElementById('editOfferSalePrice').value);
            const status = document.getElementById('editOfferStatus').value;
            const discount = Math.round((1 - salePrice / originalPrice) * 100);

            try {
                await apiCall(`/offers/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name,
                        originalPrice,
                        salePrice,
                        discount,
                        image: editOfferImageData || '',
                        isActive: status === 'active'
                    })
                });

                closeModal('editOfferModal');
                await loadOffersFromAPI();
                showAlert('success', `Offer "${name}" updated successfully!`);
            } catch (err) {
                console.error('Failed to update offer:', err);
                showAlert('error', 'Failed to update offer');
            }
        }

        // Delete offer
        function deleteOffer(id) {
            const offer = specialOffers.find(o => o.id === id);
            if (!offer) return;

            deleteOfferId = id;
            document.getElementById('deleteOfferName').textContent = offer.name;
            openModal('confirmDeleteModal');
        }

        // Confirm delete - NOW DELETES FROM API
        async function confirmDeleteOffer() {
            if (!deleteOfferId) return;

            const offer = specialOffers.find(o => o.id === deleteOfferId);

            try {
                await apiCall(`/offers/${deleteOfferId}`, { method: 'DELETE' });

                closeModal('confirmDeleteModal');
                await loadOffersFromAPI();
                showAlert('success', `Offer "${offer?.name}" deleted successfully!`);
                deleteOfferId = null;
            } catch (err) {
                console.error('Failed to delete offer:', err);
                showAlert('error', 'Failed to delete offer');
            }
        }

        // Edit page settings
        function editOfferPageSettings() {
            document.getElementById('pageTitle').value = pageSettings.title;
            document.getElementById('pageSubtitle').value = pageSettings.subtitle;
            openModal('pageSettingsModal');
        }

        // Save page settings
        function savePageSettings(event) {
            event.preventDefault();

            pageSettings.title = document.getElementById('pageTitle').value;
            pageSettings.subtitle = document.getElementById('pageSubtitle').value;

            document.getElementById('offerSubtitle').textContent = pageSettings.subtitle;

            closeModal('pageSettingsModal');
            showAlert('success', 'Page settings saved!');
        }

        // Preview offers page
        function previewOffersPage() {
            window.open('/offers.html', '_blank');
        }
    </script>
</body>

</html>

