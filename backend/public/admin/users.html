<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Freezy Bite Dashboard</title>
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* User Management Specific Styles */
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .user-stat-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .user-stat-card .icon.admins {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }

        .user-stat-card .icon.managers {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .user-stat-card .icon.staff {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .user-stat-card .icon.total {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .user-stat-card .info h4 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .user-stat-card .info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Current Admin Profile Card */
        .admin-profile-card {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            color: white;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .admin-profile-card .admin-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
        }

        .admin-profile-card .admin-info h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .admin-profile-card .admin-info p {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .admin-profile-card .admin-info .role-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .admin-profile-card .admin-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        .admin-profile-card .admin-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
        }

        .admin-profile-card .admin-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Users Table */
        .user-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-row .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-row .user-details {
            flex: 1;
        }

        .user-row .user-details .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-row .user-details .email {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .role-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .role-badge.admin {
            background: var(--primary-light);
            color: var(--primary);
        }

        .role-badge.manager {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .role-badge.staff {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-badge.inactive {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Permissions Modal Styles */
        .permission-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            margin-bottom: 1rem;
        }

        .permission-user-info .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .permission-user-info .user-details .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .permission-user-info .user-details .role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .permission-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .permission-item:hover {
            background: var(--bg-card);
            border-color: var(--primary-light);
        }

        .permission-item.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .permission-item .permission-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .permission-item.active .permission-icon {
            background: var(--primary);
            color: white;
        }

        .permission-item .permission-label {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .permission-item .permission-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: transparent;
            transition: all 0.2s;
        }

        .permission-item.active .permission-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .admin-profile-card {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem;
            }

            .admin-profile-card .admin-avatar {
                width: 70px;
                height: 70px;
            }

            .admin-profile-card .admin-info h2 {
                font-size: 1.25rem;
            }

            .admin-profile-card .admin-actions {
                margin-left: 0;
                margin-top: 1rem;
            }

            .user-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .user-stat-card {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            .user-stat-card .icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .user-stat-card .info h4 {
                font-size: 1.25rem;
            }

            .user-stat-card .info p {
                font-size: 0.75rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .section-actions {
                width: 100%;
            }

            .section-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .user-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-logo">
                <div class="logo-icon">
                    <i class="fas fa-snowflake"></i>
                </div>
                <span>Freezy Bite</span>
            </a>
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li>
                    <a href="index.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">Overview</span>
                    </a>
                </li>
                <li>
                    <a href="content.html" class="nav-item">
                        <i class="fas fa-palette"></i>
                        <span class="nav-text">Website Content</span>
                    </a>
                </li>
                <li>
                    <a href="offers.html" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span class="nav-text">Special Offers</span>
                    </a>
                </li>
                <li>
                    <a href="products.html" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span class="nav-text">Products</span>
                    </a>
                </li>
                <li>
                    <a href="orders.html" class="nav-item">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="nav-text">Orders</span>
                    </a>
                </li>
                <li>
                    <a href="customers.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Customers</span>
                    </a>
                </li>
                <li>
                    <a href="messages.html" class="nav-item">
                        <i class="fas fa-envelope"></i>
                        <span class="nav-text">Messages</span>
                    </a>
                </li>
                <li>
                    <a href="analytics.html" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-text">Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="inventory.html" class="nav-item">
                        <i class="fas fa-warehouse"></i>
                        <span class="nav-text">Inventory</span>
                    </a>
                </li>
                <li>
                    <a href="employees.html" class="nav-item">
                        <i class="fas fa-id-badge"></i>
                        <span class="nav-text">Employees</span>
                    </a>
                </li>
                <li>
                    <a href="users.html" class="nav-item active">
                        <i class="fas fa-user-shield"></i>
                        <span class="nav-text">Users</span>
                    </a>
                </li>
                <li>
                    <a href="trash.html" class="nav-item">
                        <i class="fas fa-trash-alt"></i>
                        <span class="nav-text">Trash</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span class="nav-text">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <img src="/assets/icons/profile.svg" alt="Admin" class="user-avatar">
                <div class="user-info">
                    <h4>Admin User</h4>
                    <p>admin@freezybite.com</p>
                </div>
            </div>
            <button class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search users...">
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="badge" style="display: none;"></span>
                </button>
                <button class="header-btn" onclick="showMessages()">
                    <i class="fas fa-envelope"></i>
                    <span class="badge" style="display: none;"></span>
                </button>
                <button class="header-btn" onclick="showTrashModal()" title="Trash">
                    <i class="fas fa-trash-alt"></i>
                    <span class="badge" id="headerTrashBadge" style="display: none;"></span>
                </button>
                <img src="/assets/icons/profile.svg" alt="Admin" class="header-avatar" onclick="openEditProfileModal()">
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Current Admin Profile -->
            <div class="admin-profile-card" id="currentAdminProfile">
                <img src="/assets/icons/profile.svg" alt="Admin" class="admin-avatar" id="adminAvatar">
                <div class="admin-info">
                    <h2 id="adminName">Admin User</h2>
                    <p id="adminEmail"><i class="fas fa-envelope"></i> admin@freezybite.com</p>
                    <p id="adminPhone"><i class="fas fa-phone"></i> +20 109 396 1545</p>
                    <span class="role-badge" id="adminRole">Super Admin</span>
                </div>
                <div class="admin-actions">
                    <button class="btn btn-sm" onclick="openEditProfileModal()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="btn btn-sm" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </div>

            <!-- Section Header -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title"><i class="fas fa-user-shield"
                                style="color: var(--primary); margin-right: 0.5rem;"></i>User Management</h1>
                        <p class="section-subtitle">Manage administrators, managers, and staff accounts.</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            <i class="fas fa-user-plus"></i>
                            Add User
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Stats -->
            <div class="user-stats">
                <div class="user-stat-card">
                    <div class="icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="info">
                        <h4 id="totalUsersCount">--</h4>
                        <p>Total Users</p>
                    </div>
                </div>
                <div class="user-stat-card">
                    <div class="icon admins">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="info">
                        <h4 id="adminsCount">--</h4>
                        <p>Admins</p>
                    </div>
                </div>
                <div class="user-stat-card">
                    <div class="icon managers">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="info">
                        <h4 id="managersCount">--</h4>
                        <p>Managers</p>
                    </div>
                </div>
                <div class="user-stat-card">
                    <div class="icon staff">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="info">
                        <h4 id="staffCount">--</h4>
                        <p>Staff</p>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="data-card">
                <div class="data-card-header">
                    <h3 class="data-card-title">All Users</h3>
                    <div class="data-card-actions">
                        <select class="form-select" id="roleFilter" onchange="filterUsersByRole(this.value)"
                            style="min-width: 120px;">
                            <option value="">All Roles</option>
                            <option value="admin">Admins</option>
                            <option value="manager">Managers</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper" id="usersTableBody">
                    <!-- Users table will be rendered here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"
                        style="color: var(--primary); margin-right: 0.5rem;"></i>Add New User</h2>
                <button class="modal-close" onclick="closeModal('addUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addUserForm" onsubmit="addNewUser(event)">
                <div class="modal-body">
                    <!-- Profile Picture Upload -->
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="position: relative; display: inline-block;">
                            <img src="/assets/icons/profile.svg" alt="Avatar" id="newUserAvatarPreview"
                                style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary-light); object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-primary"
                                onclick="document.getElementById('newUserAvatarInput').click()"
                                style="position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; padding: 0; border-radius: 50%;">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <input type="file" id="newUserAvatarInput" accept="image/*" style="display: none;"
                            onchange="previewNewUserAvatar(event)">
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Click camera to
                            upload photo</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="newUserName" placeholder="Enter full name" required
                            oninput="updateNewUserAvatarPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-input" id="newUserEmail" placeholder="Enter email address"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="newUserPhone" placeholder="+20 1XX XXX XXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role <span class="required">*</span></label>
                        <select class="form-select" id="newUserRole" required onchange="updateNewUserAvatarColor()">
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password <span class="required">*</span></label>
                        <input type="password" class="form-input" id="newUserPassword" placeholder="Enter password"
                            required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password <span class="required">*</span></label>
                        <input type="password" class="form-input" id="newUserConfirmPassword"
                            placeholder="Confirm password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-edit"
                        style="color: var(--primary); margin-right: 0.5rem;"></i>Edit User</h2>
                <button class="modal-close" onclick="closeModal('editUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editUserForm" onsubmit="updateUser(event)">
                <input type="hidden" id="editUserId">
                <div class="modal-body">
                    <!-- Profile Picture Upload -->
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="position: relative; display: inline-block;">
                            <img src="" alt="Avatar" id="editUserAvatarPreview"
                                style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary-light); object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-primary"
                                onclick="document.getElementById('editUserAvatarInput').click()"
                                style="position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; padding: 0; border-radius: 50%;">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <input type="file" id="editUserAvatarInput" accept="image/*" style="display: none;"
                            onchange="previewEditUserAvatar(event)">
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Click camera to
                            change photo</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="editUserName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-input" id="editUserEmail" placeholder="Enter email address"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="editUserPhone" placeholder="+20 1XX XXX XXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role <span class="required">*</span></label>
                        <select class="form-select" id="editUserRole" required>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editUserStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-circle"
                        style="color: var(--primary); margin-right: 0.5rem;"></i>Edit My Profile</h2>
                <button class="modal-close" onclick="closeModal('editProfileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editProfileForm" onsubmit="updateProfile(event)">
                <div class="modal-body">
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <img src="/assets/icons/profile.svg" alt="Admin" id="profileAvatarPreview"
                            style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem;">
                        <div>
                            <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;"
                                onchange="previewProfileAvatar(event)">
                            <button type="button" class="btn btn-sm btn-secondary"
                                onclick="document.getElementById('profileAvatarInput').click()">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="profileName" value="Admin User" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-input" id="profileEmail" value="admin@freezybite.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="profilePhone" value="+20 109 396 1545">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editProfileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-key"
                        style="color: var(--warning); margin-right: 0.5rem;"></i>Change Password</h2>
                <button class="modal-close" onclick="closeModal('changePasswordModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Current Password <span class="required">*</span></label>
                        <input type="password" class="form-input" id="currentPassword"
                            placeholder="Enter current password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password <span class="required">*</span></label>
                        <input type="password" class="form-input" id="newPassword" placeholder="Enter new password"
                            required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password <span class="required">*</span></label>
                        <input type="password" class="form-input" id="confirmNewPassword"
                            placeholder="Confirm new password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('changePasswordModal')">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Permissions Modal -->
    <div class="modal-overlay" id="permissionsModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-shield-alt"
                        style="color: var(--primary); margin-right: 0.5rem;"></i>Manage Permissions</h2>
                <button class="modal-close" onclick="closeModal('permissionsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- User Info -->
                <div class="permission-user-info" id="permissionUserInfo">
                    <!-- Filled by JS -->
                </div>

                <!-- Quick Actions -->
                <div class="permission-quick-actions">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllPermissions()">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllPermissions()">
                        <i class="fas fa-times"></i> Deselect All
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="resetToDefaultPermissions()">
                        <i class="fas fa-undo"></i> Reset to Role Default
                    </button>
                </div>

                <!-- Permissions Grid -->
                <div class="permissions-grid" id="permissionsGrid">
                    <!-- Filled by JS -->
                </div>

                <input type="hidden" id="permissionUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('permissionsModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePermissions()">
                    <i class="fas fa-save"></i> Save Permissions
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/dashboard.js"></script>
    <script>
        // Current admin user
        let currentAdmin = {
            id: null,
            name: '',
            email: '',
            phone: '',
            role: 'admin',
            status: 'active',
            avatar: '/assets/icons/profile.svg'
        };

        // All available pages/permissions
        const allPages = [
            { key: 'overview', label: 'Overview', icon: 'fas fa-home' },
            { key: 'content', label: 'Website Content', icon: 'fas fa-edit' },
            { key: 'products', label: 'Products', icon: 'fas fa-box' },
            { key: 'orders', label: 'Orders', icon: 'fas fa-shopping-cart' },
            { key: 'customers', label: 'Customers', icon: 'fas fa-users' },
            { key: 'messages', label: 'Messages', icon: 'fas fa-envelope' },
            { key: 'analytics', label: 'Analytics', icon: 'fas fa-chart-line' },
            { key: 'inventory', label: 'Inventory', icon: 'fas fa-warehouse' },
            { key: 'offers', label: 'Offers', icon: 'fas fa-tags' },
            { key: 'employees', label: 'Employees', icon: 'fas fa-id-badge' },
            { key: 'users', label: 'Users', icon: 'fas fa-user-shield' },
            { key: 'settings', label: 'Settings', icon: 'fas fa-cog' },
            { key: 'trash', label: 'Trash', icon: 'fas fa-trash' }
        ];

        // Default access by role
        const defaultAccessByRole = {
            'super-admin': ['all'],
            'admin': ['overview', 'content', 'products', 'orders', 'customers', 'messages', 'analytics', 'inventory', 'offers', 'employees', 'users', 'trash', 'settings'],
            'manager': ['overview', 'content', 'products', 'orders', 'customers', 'messages', 'analytics', 'inventory', 'offers', 'trash'],
            'staff': ['products', 'orders', 'customers', 'inventory', 'messages', 'trash']
        };

        // Users data - loaded from API
        let users = [];

        // Temporary avatar storage for new/edit user
        let newUserAvatarData = null;
        let editUserAvatarData = null;

        // Load users from API
        async function loadUsersFromAPI() {
            try {
                const res = await fetch('/api/admin/users', { cache: 'no-store' });
                if (res.ok) {
                    users = await res.json();
                    // Normalize fields for frontend compatibility
                    users = users.map(u => ({
                        ...u,
                        role: (u.role || 'staff').toLowerCase(),
                        status: u.isActive !== false ? 'active' : 'inactive',
                        lastLogin: u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-'
                    }));
                }
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function () {
            await loadUsersFromAPI();
            renderUsersTable();
            updateUserStats();
            loadAdminProfile();
        });

        // Render users table
        function renderUsersTable(filter = '') {
            const container = document.getElementById('usersTableBody');
            if (!container) return;

            let filteredUsers = users;
            if (filter) {
                filteredUsers = users.filter(u => u.role === filter);
            }

            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No users found</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredUsers.forEach(user => {
                const defaultAvatarUrl = `/assets/icons/profile.svg`;
                const avatarUrl = user.avatar || defaultAvatarUrl;
                const isCurrentAdmin = user.id === currentAdmin.id;

                html += `
                    <tr>
                        <td>
                            <div class="user-row">
                                <img src="${avatarUrl}" alt="${user.name}" class="user-avatar" style="object-fit: cover;">
                                <div class="user-details">
                                    <div class="name">${user.name} ${isCurrentAdmin ? '<span style="font-size: 0.7rem; color: var(--primary);">(You)</span>' : ''}</div>
                                    <div class="email">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="role-badge ${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                        </td>
                        <td>
                            <span class="badge ${user.status === 'active' ? 'badge-success' : 'badge-danger'}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span>
                        </td>
                        <td>${user.lastLogin}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${!isCurrentAdmin && isSuperAdmin() ? `
                                <button class="btn btn-sm btn-primary" onclick="openPermissionsModal(${user.id})" title="Manage Permissions">
                                    <i class="fas fa-shield-alt"></i>
                                </button>
                                ` : ''}
                                ${!isCurrentAdmin ? `
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update user stats
        function updateUserStats() {
            const total = users.length;
            const admins = users.filter(u => u.role === 'admin').length;
            const managers = users.filter(u => u.role === 'manager').length;
            const staff = users.filter(u => u.role === 'staff').length;

            document.getElementById('totalUsersCount').textContent = total;
            document.getElementById('adminsCount').textContent = admins;
            document.getElementById('managersCount').textContent = managers;
            document.getElementById('staffCount').textContent = staff;
        }

        // Load admin profile
        function loadAdminProfile() {
            document.getElementById('adminName').textContent = currentAdmin.name;
            document.getElementById('adminEmail').innerHTML = `<i class="fas fa-envelope"></i> ${currentAdmin.email}`;
            document.getElementById('adminPhone').innerHTML = `<i class="fas fa-phone"></i> ${currentAdmin.phone}`;
            document.getElementById('adminRole').textContent = 'Super Admin';

            // Use custom avatar if exists, otherwise generate one
            const adminUser = users.find(u => u.id === currentAdmin.id);
            const defaultAvatarUrl = `/assets/icons/profile.svg`;
            const avatarUrl = (adminUser && adminUser.avatar) || defaultAvatarUrl;
            document.getElementById('adminAvatar').src = avatarUrl;
        }

        // Filter users by role
        function filterUsersByRole(role) {
            renderUsersTable(role);
        }

        // Open add user modal
        function openAddUserModal() {
            document.getElementById('addUserForm').reset();
            newUserAvatarData = null;
            // Reset avatar preview
            document.getElementById('newUserAvatarPreview').src = '/assets/icons/profile.svg';
            openModal('addUserModal');
        }

        // Preview new user avatar
        function previewNewUserAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    newUserAvatarData = e.target.result;
                    document.getElementById('newUserAvatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Update new user avatar preview based on name
        function updateNewUserAvatarPreview() {
            if (newUserAvatarData) return; // Don't update if custom avatar is set
            document.getElementById('newUserAvatarPreview').src = `/assets/icons/profile.svg`;
        }

        // Update new user avatar color based on role
        function updateNewUserAvatarColor() {
            if (newUserAvatarData) return; // Don't update if custom avatar is set
            updateNewUserAvatarPreview();
        }

        // Add new user
        async function addNewUser(event) {
            event.preventDefault();

            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const phone = document.getElementById('newUserPhone').value;
            const role = document.getElementById('newUserRole').value;
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;

            if (password !== confirmPassword) {
                showAlert('error', 'Passwords do not match!');
                return;
            }

            try {
                const res = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name, role, avatar: newUserAvatarData })
                });
                const data = await res.json();

                if (!res.ok) {
                    showAlert('error', data.error || 'Failed to add user');
                    return;
                }

                newUserAvatarData = null;
                closeModal('addUserModal');
                await loadUsersFromAPI();
                renderUsersTable(document.getElementById('roleFilter').value);
                updateUserStats();
                showAlert('success', `User "${name}" added successfully!`);
            } catch (err) {
                console.error('Add user error:', err);
                showAlert('error', 'Failed to add user. Please try again.');
            }
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editUserAvatarData = null; // Reset

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserStatus').value = user.status;

            // Set avatar preview
            const defaultAvatarUrl = `/assets/icons/profile.svg`;
            document.getElementById('editUserAvatarPreview').src = user.avatar || defaultAvatarUrl;

            // Disable role change for current admin
            document.getElementById('editUserRole').disabled = user.id === currentAdmin.id;
            document.getElementById('editUserStatus').disabled = user.id === currentAdmin.id;

            openModal('editUserModal');
        }

        // Preview edit user avatar
        function previewEditUserAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    editUserAvatarData = e.target.result;
                    document.getElementById('editUserAvatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Update user
        async function updateUser(event) {
            event.preventDefault();

            const userId = parseInt(document.getElementById('editUserId').value);

            const updateData = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                role: document.getElementById('editUserRole').value,
                isActive: document.getElementById('editUserStatus').value === 'active',
                avatar: editUserAvatarData || undefined
            };

            try {
                const res = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                const data = await res.json();

                if (!res.ok) {
                    showAlert('error', data.error || 'Failed to update user');
                    return;
                }

                editUserAvatarData = null;
                closeModal('editUserModal');
                await loadUsersFromAPI();
                renderUsersTable(document.getElementById('roleFilter').value);
                updateUserStats();
                loadAdminProfile();
                showAlert('success', `User "${updateData.name}" updated successfully!`);
            } catch (err) {
                console.error('Update user error:', err);
                showAlert('error', 'Failed to update user. Please try again.');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (user.id === currentAdmin.id) {
                showAlert('error', 'You cannot delete your own account!');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${user.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    showAlert('error', data.error || 'Failed to delete user');
                    return;
                }

                await loadUsersFromAPI();
                renderUsersTable(document.getElementById('roleFilter').value);
                updateUserStats();
                showAlert('success', `User "${user.name}" deleted successfully!`);
            } catch (err) {
                console.error('Delete user error:', err);
                showAlert('error', 'Failed to delete user. Please try again.');
            }
        }

        // Temporary storage for profile avatar
        let profileAvatarData = null;

        // Open edit profile modal
        function openEditProfileModal() {
            profileAvatarData = null; // Reset
            document.getElementById('profileName').value = currentAdmin.name;
            document.getElementById('profileEmail').value = currentAdmin.email;
            document.getElementById('profilePhone').value = currentAdmin.phone || '';

            // Use custom avatar if exists
            const adminUser = users.find(u => u.id === currentAdmin.id);
            const defaultAvatarUrl = `/assets/icons/profile.svg`;
            const avatarUrl = (adminUser && adminUser.avatar) || defaultAvatarUrl;
            document.getElementById('profileAvatarPreview').src = avatarUrl;

            openModal('editProfileModal');
        }

        // Preview profile avatar
        function previewProfileAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    profileAvatarData = e.target.result;
                    document.getElementById('profileAvatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Update profile
        function updateProfile(event) {
            event.preventDefault();

            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            const phone = document.getElementById('profilePhone').value;

            // Update current admin
            currentAdmin.name = name;
            currentAdmin.email = email;
            currentAdmin.phone = phone;

            // Update avatar if new one was uploaded
            if (profileAvatarData) {
                currentAdmin.avatar = profileAvatarData;
            }

            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentAdmin.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].email = email;
                users[userIndex].phone = phone;
                if (profileAvatarData) {
                    users[userIndex].avatar = profileAvatarData;
                }
            }

            profileAvatarData = null; // Reset

            loadAdminProfile();
            renderUsersTable(document.getElementById('roleFilter').value);

            closeModal('editProfileModal');
            showAlert('success', 'Profile updated successfully!');
        }

        // Open change password modal
        function openChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            openModal('changePasswordModal');
        }

        // Change password
        function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // Simple validation (in real app, would verify current password)
            if (currentPassword.length < 6) {
                showAlert('error', 'Current password is incorrect!');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showAlert('error', 'New passwords do not match!');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('error', 'New password must be at least 6 characters!');
                return;
            }

            closeModal('changePasswordModal');
            showAlert('success', 'Password changed successfully!');
        }

        // ===== PERMISSION MANAGEMENT =====

        // Check if current user is Super Admin
        function isSuperAdmin() {
            const currentUser = JSON.parse(localStorage.getItem('freezyBiteCurrentUser'));
            return currentUser && (currentUser.isOwner || currentUser.role === 'Super Admin');
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('freezyBiteUsers', JSON.stringify(users));
        }

        // Open permissions modal
        function openPermissionsModal(userId) {
            if (!isSuperAdmin()) {
                showAlert('error', 'Only Super Admin can manage permissions!');
                return;
            }

            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Set user ID
            document.getElementById('permissionUserId').value = userId;

            // Render user info
            const defaultAvatarUrl = `/assets/icons/profile.svg`;
            const avatarUrl = user.avatar || defaultAvatarUrl;

            document.getElementById('permissionUserInfo').innerHTML = `
                <img src="${avatarUrl}" alt="${user.name}" class="user-avatar">
                <div class="user-details">
                    <div class="name">${user.name}</div>
                    <div class="role">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}  ${user.email}</div>
                </div>
            `;

            // Render permissions grid
            renderPermissionsGrid(user);

            openModal('permissionsModal');
        }

        // Render permissions grid
        function renderPermissionsGrid(user) {
            const container = document.getElementById('permissionsGrid');
            const userAccess = user.access || [];

            container.innerHTML = allPages.map(page => {
                const hasAccess = userAccess.includes(page.key);
                return `
            < div class="permission-item ${hasAccess ? 'active' : ''}" onclick = "togglePermission('${page.key}', this)" >
                        <div class="permission-icon">
                            <i class="${page.icon}"></i>
                        </div>
                        <span class="permission-label">${page.label}</span>
                        <div class="permission-check">
                            <i class="fas fa-check"></i>
                        </div>
                    </div >
            `;
            }).join('');
        }

        // Toggle permission
        function togglePermission(key, element) {
            element.classList.toggle('active');
        }

        // Select all permissions
        function selectAllPermissions() {
            document.querySelectorAll('.permission-item').forEach(item => {
                item.classList.add('active');
            });
        }

        // Deselect all permissions
        function deselectAllPermissions() {
            document.querySelectorAll('.permission-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Reset to default permissions based on role
        function resetToDefaultPermissions() {
            const userId = parseInt(document.getElementById('permissionUserId').value);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const defaultAccess = defaultAccessByRole[user.role] || defaultAccessByRole['staff'];

            document.querySelectorAll('.permission-item').forEach(item => {
                const key = item.querySelector('.permission-label').textContent;
                const page = allPages.find(p => p.label === key);
                if (page && defaultAccess.includes(page.key)) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            showAlert('info', 'Permissions reset to role defaults');
        }

        // Save permissions
        async function savePermissions() {
            const userId = parseInt(document.getElementById('permissionUserId').value);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Collect selected permissions
            const selectedPermissions = [];
            document.querySelectorAll('.permission-item.active').forEach(item => {
                const label = item.querySelector('.permission-label').textContent;
                const page = allPages.find(p => p.label === label);
                if (page) {
                    selectedPermissions.push(page.key);
                }
            });

            try {
                const res = await fetch(`/ api / admin / users / ${userId} `, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ access: selectedPermissions })
                });

                if (!res.ok) {
                    showAlert('error', 'Failed to save permissions');
                    return;
                }

                // Also update in registered users if they're logged in with this user
                updateRegisteredUserAccess({ ...user, access: selectedPermissions });

                await loadUsersFromAPI();
                closeModal('permissionsModal');
                renderUsersTable(document.getElementById('roleFilter').value);
                showAlert('success', `Permissions updated for ${user.name}!`);
            } catch (err) {
                console.error('Save permissions error:', err);
                showAlert('error', 'Failed to save permissions. Please try again.');
            }
        }

        // Update registered user access (for login sync)
        function updateRegisteredUserAccess(user) {
            // Check if this user is currently logged in
            const currentUser = JSON.parse(localStorage.getItem('freezyBiteCurrentUser'));
            if (currentUser && currentUser.email === user.email) {
                currentUser.access = user.access;
                localStorage.setItem('freezyBiteCurrentUser', JSON.stringify(currentUser));
            }
        }
    </script>
</body>

</html>